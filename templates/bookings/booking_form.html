<!-- bookings/templates/bookings/booking_form.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Form</title>
    {% load static %}
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <meta name="csrf-token" content="{{ csrf_token }}" />
  </head>
  <body>
    <h2>Booking Form</h2>
    <form id="bookingForm">
      <label for="name">Name:</label>
      <input type="text" id="name" name="name" required /><br /><br />

      <label for="phone">Phone:</label>
      <input type="text" id="phone" name="phone" required /><br /><br />

      <label for="email">Email:</label>
      <input type="email" id="email" name="email" required /><br /><br />

      <label for="city">City:</label>
      <input type="text" id="city" name="city" required /><br /><br />

      <label for="package">Package:</label>
      <select id="package" name="package" required>
        <!-- Package options will be loaded here dynamically --></select
      ><br /><br />

      <label for="arrival_date">Arrival Date:</label>
      <input
        type="date"
        id="arrival_date"
        name="arrival_date"
        required
      /><br /><br />

      <label for="departure_date">Departure Date:</label>
      <input
        type="date"
        id="departure_date"
        name="departure_date"
        required
      /><br /><br />

      <label for="num_adults">Number of Adults:</label>
      <input
        type="number"
        id="num_adults"
        name="num_adults"
        value="1"
        min="1"
        required
      /><br /><br />

      <label for="num_children">Number of Children:</label>
      <input
        type="number"
        id="num_children"
        name="num_children"
        value="0"
        min="0"
      /><br /><br />

      <div id="child_ages_section" style="display: none">
        <h4>Child Ages (years):</h4>
        <div id="child_ages"></div>
      </div>

      <p>
        <strong>Total Amount: â‚¹<span id="totalAmount">0</span></strong>
      </p>
      <button type="button" onclick="submitBooking()">Proceed to Pay</button>
    </form>

    <script>
      let packages = [];
      let adultPrice = 0;
      let childPrice = 0;

      // Fetch available packages from the backend when the page loads
      function fetchPackages() {
        fetch("/api/packages/")
          .then((response) => response.json())
          .then((data) => {
            packages = data;
            const packageSelect = document.getElementById("package");
            packages.forEach((pkg) => {
              const option = document.createElement("option");
              option.value = pkg.id;
              option.text = pkg.name;
              option.dataset.adultPrice = pkg.adult_price;
              option.dataset.childPrice = pkg.child_price;
              packageSelect.appendChild(option);
            });
            // Update prices when the first package is loaded
            updatePrices();
          })
          .catch((error) => console.error("Error fetching packages:", error));
      }

      // Update prices based on the selected package
      function updatePrices() {
        const selectedPackage =
          document.getElementById("package").options[
            document.getElementById("package").selectedIndex
          ];
        adultPrice = parseFloat(selectedPackage.dataset.adultPrice);
        childPrice = parseFloat(selectedPackage.dataset.childPrice);
        fetchAndCalculateTotal(); // Recalculate total whenever package changes
      }

      // Update child ages field based on the number of children
      document
        .getElementById("num_children")
        .addEventListener("change", function () {
          const numChildren = parseInt(this.value);
          const childAgesSection =
            document.getElementById("child_ages_section");
          const childAgesDiv = document.getElementById("child_ages");
          childAgesDiv.innerHTML = "";

          if (numChildren > 0) {
            childAgesSection.style.display = "block";
            for (let i = 1; i <= numChildren; i++) {
              childAgesDiv.innerHTML += `<label>Child ${i} Age: </label><input type="number" name="child_age_${i}" min="1" max="17"><br>`;
            }
          } else {
            childAgesSection.style.display = "none";
          }
          fetchAndCalculateTotal(); // Recalculate total when number of children changes
        });

      // Update the total amount when number of adults changes
      document
        .getElementById("num_adults")
        .addEventListener("change", function () {
          fetchAndCalculateTotal(); // Recalculate total when number of adults changes
        });

      // Calculate the total amount based on adults and children
      function fetchAndCalculateTotal() {
        const numAdults = parseInt(document.getElementById("num_adults").value);
        const numChildren = parseInt(
          document.getElementById("num_children").value
        );

        const totalAmount = numAdults * adultPrice + numChildren * childPrice;
        document.getElementById("totalAmount").innerText =
          totalAmount.toFixed(2); // Format to 2 decimal places
        return totalAmount;
      }

      // Submit booking details and initiate Razorpay payment
      function submitBooking() {
        const totalAmount = fetchAndCalculateTotal();
        const csrfToken = document
          .querySelector('meta[name="csrf-token"]')
          .getAttribute("content");

        const formData = {
          name: document.getElementById("name").value,
          phone: document.getElementById("phone").value,
          email: document.getElementById("email").value,
          city: document.getElementById("city").value,
          package: document.getElementById("package").value,
          arrival_date: document.getElementById("arrival_date").value,
          departure_date: document.getElementById("departure_date").value,
          num_adults: parseInt(document.getElementById("num_adults").value),
          num_children: parseInt(document.getElementById("num_children").value),
          child_ages: Array.from(
            document.querySelectorAll('[name^="child_age_"]')
          ).map((input) => parseInt(input.value)),
        };

        fetch("/api/bookings/create/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken, // Include the CSRF token here
          },
          body: JSON.stringify(formData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.order_id) {
              const options = {
                key: data.razorpay_key,
                amount: data.amount * 100,
                currency: data.currency,
                order_id: data.order_id,
                handler: function (response) {
                  alert("Payment Successful!");
                  fetch("/api/bookings/confirm", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "X-CSRFToken": csrfToken, // Include the CSRF token here as well
                    },
                    body: JSON.stringify({
                      booking_id: data.booking_id,
                      razorpay_payment_id: response.razorpay_payment_id,
                      razorpay_order_id: response.razorpay_order_id,
                      razorpay_signature: response.razorpay_signature,
                    }), 
                  });
                },
                prefill: {
                  name: formData.name,
                  contact: formData.phone,
                },
              };
              const rzp1 = new Razorpay(options);
              rzp1.open();
            } else {
              alert("Failed to create booking.");
            }
          })
          .catch((error) => console.error("Error:", error));
      }

      // Fetch packages when the page loads
      window.onload = fetchPackages;
    </script>
  </body>
</html>
